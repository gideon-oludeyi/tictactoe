<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tictactoe | Web Browser</title>
    <style>
        * {
            box-sizing: border-box;
        }

        #board {
            display: grid;
            width: 16em;
            height: 16em;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            justify-items: center;
            align-items: center;
            border: 1px solid black;
        }

        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            border: 1px solid black;
        }

        #player-display::after {
            content: attr(player);
        }
        
        #winner-display::after {
            content: attr(winner);
        }

        .square[mark='X'] {
            background-color: blueviolet;
        }
        
        .square[mark='O'] {
            background-color: orange;
        }
    </style>
</head>
<body>
    <h1>Tictactoe</h1>
    <button id="new-game" onclick="newGame()">New Game</button>
    <h3 id="player-display" player="X">Current Player: </h3>
    <h3 id="winner-display" winner="" hidden>Winner: </h3>
    <h3 id="no-winner-display" hidden>Draw</h3>
    <div id="board"></div>

    <script defer>
        let currentPlayer = 'X';
        let winner = '';
        let moves = [];

        function displayTag(id) {
            const playerEl = document.getElementById('player-display');
            const winnerEl = document.getElementById('winner-display');
            const drawEl = document.getElementById('no-winner-display');
            switch (id) {
                case 'player-display':
                    playerEl.removeAttribute('hidden');
                    winnerEl.setAttribute('hidden', '');
                    drawEl.setAttribute('hidden', '');
                    break;
                case 'winner-display':
                    winnerEl.removeAttribute('hidden');
                    playerEl.setAttribute('hidden', '');
                    drawEl.setAttribute('hidden', '');
                    break;
                case 'no-winner-display':
                    drawEl.removeAttribute('hidden');
                    winnerEl.setAttribute('hidden', '');
                    playerEl.setAttribute('hidden', '');
                    break;
            }
        }

        function resetWinner() {
            winner = '';
            const tag = document.getElementById('winner-display');
            tag.setAttribute('winner', '');
        }

        function setWinner(mark) {
            winner = mark;
            const tag = document.getElementById('winner-display');
            tag.setAttribute('winner', mark);
            displayTag('winner-display');
        }

        function setPlayer(mark) {
            currentPlayer = mark;
            const tag = document.getElementById('player-display');
            tag.setAttribute('player', mark);
            displayTag('player-display');
        }

        function isWinner(squares, player, [x,y]) {
            // Solution: https://stackoverflow.com/questions/1056316/algorithm-for-determining-tic-tac-toe-game-over/1058804#1058804
            const marks = squares.map(square => square.getAttribute('mark'));
            const grid = [marks.slice(0,3), marks.slice(3,6), marks.slice(6,9)];
            const n = 3;
            let col = row = diag = rdiag = 0;
            for (let i = 0; i < n; i++) {
                if (grid[x][i] === player) {
                    col++;
                }
                if (grid[i][y] === player) {
                    row++;
                }
                if (grid[i][i] === player) {
                    diag++;
                }
                if (grid[i][n-(i+1)] === player) {
                    rdiag++;
                }
            }
            return col===n || row===n || diag===n || rdiag===n;
        }

        function createSquare(key) {
            const square = document.createElement('DIV');
            square.setAttribute('class', 'square');
            square.setAttribute('key', `${key}`);
            return square;
        }

        function subscribe(square) {
            function listener() {
                square.setAttribute('mark', currentPlayer);
                square.innerHTML = currentPlayer;
                setPlayer(currentPlayer === 'X' ? 'O' : 'X');
                const key = Number(square.getAttribute('key')) - 1;
                moves.push([Math.floor(key / 3), key % 3]);
            }

            square.addEventListener('click', listener, { once: true });
            return {
                unsubscribe() {
                    square.removeEventListener('click', listener);
                },
            };
        }

        function newGame() {
            setPlayer('X');
            resetWinner('');

            const board = document.getElementById('board');

            let subscriptions = [];

            for (let i = 0; i < 9; i++) {
                const square = board.children.item(i);
                const newSquare = createSquare(i+1);
                const subscription = subscribe(newSquare);
                subscriptions.push(subscription);
                if (square) {
                    board.replaceChild(newSquare, square);
                } else {
                    board.appendChild(newSquare);
                }
            }

            board.addEventListener('click', function listener() {
                const squares = Array.from(board.children);
                const candidate = currentPlayer === 'X' ? 'O' : 'X';
                const prevMove = moves[moves.length-1];
                const won = isWinner(squares, candidate, prevMove);
                const boardIsFull = squares.every(square => square.hasAttribute('mark'));

                function unsubscribeAll() {
                    subscriptions.forEach(subscription => subscription.unsubscribe());
                    subscriptions = [];
                }

                if (won) {
                    board.removeEventListener('click', listener);
                    unsubscribeAll();
                    setWinner(candidate);
                } else if (boardIsFull) {
                    board.removeEventListener('click', listener);
                    unsubscribeAll();
                    displayTag('no-winner-display');
                }
            })
        }

        newGame(); // automatically start the game
    </script>
</body>
</html>